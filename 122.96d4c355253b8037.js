"use strict";(self.webpackChunkweb_mzima_client=self.webpackChunkweb_mzima_client||[]).push([[122],{68122:(_t,v,a)=>{a.r(v),a.d(v,{DataExportModule:()=>d});var p=a(52954),m=a(93557),O=a(95432),C=a(29383),A=a(952),T=a(37661),r=a(25303),g=a(94367),E=a(81547),D=a(89857),u=a(40930),y=a(4540),c=a(49119),J=a(20117),s=a(59132),t=a(39609),S=a(53625),U=a(6469),M=a(93149);function L(e,o){1&e&&(t._UZ(0,"p",14),t.ALo(1,"translate")),2&e&&t.Q6J("innerHTML",t.lcZ(1,1,"data_export.export_progress"),t.oJD)}const j=function(){return["/settings/user-settings"]};function q(e,o){1&e&&(t.ynx(0),t.TgZ(1,"div",15)(2,"p"),t._uU(3),t.ALo(4,"translate"),t.qZA(),t.TgZ(5,"p"),t._uU(6),t.ALo(7,"translate"),t.TgZ(8,"a",16),t._uU(9),t.ALo(10,"translate"),t.qZA(),t._uU(11),t.ALo(12,"translate"),t.qZA()(),t.BQk()),2&e&&(t.xp6(3),t.Oqu(t.lcZ(4,5,"data_export.hxl_apikey_alert_1")),t.xp6(3),t.hij(" ",t.lcZ(7,7,"data_export.hxl_apikey_alert_2")," "),t.xp6(2),t.Q6J("routerLink",t.DdM(13,j)),t.xp6(1),t.hij(" ",t.lcZ(10,9,"data_export.hxl_configure")," "),t.xp6(2),t.hij(" ",t.lcZ(12,11,"data_export.hxl_apikey_alert_3")," "))}function N(e,o){1&e&&t._UZ(0,"div",17)}function Y(e,o){1&e&&(t.TgZ(0,"th",32),t._uU(1),t.ALo(2,"translate"),t.qZA()),2&e&&(t.xp6(1),t.Oqu(t.lcZ(2,1,"app.name")))}const w=function(e){return{jobId:e}};function Q(e,o){if(1&e&&(t.TgZ(0,"td",33)(1,"span",34),t._uU(2),t.ALo(3,"translate"),t.qZA()()),2&e){const n=o.$implicit;t.xp6(2),t.hij("",t.xi3(3,1,"data_export.job",t.VKq(4,w,n.id))," ")}}function I(e,o){1&e&&(t.TgZ(0,"th",32),t._uU(1),t.ALo(2,"translate"),t.qZA()),2&e&&(t.xp6(1),t.Oqu(t.lcZ(2,1,"global_filter.status")))}function P(e,o){if(1&e&&(t.TgZ(0,"td",33),t._uU(1),t.ALo(2,"titlecase"),t.qZA()),2&e){const n=o.$implicit;t.xp6(1),t.Oqu(t.lcZ(2,1,n.status))}}function F(e,o){1&e&&(t.TgZ(0,"th",32),t._uU(1),t.ALo(2,"translate"),t.qZA()),2&e&&(t.xp6(1),t.hij(" ",t.lcZ(2,1,"global_filter.sort.orderby.created")," "))}function z(e,o){if(1&e&&(t.TgZ(0,"td",33),t._uU(1),t.qZA()),2&e){const n=o.$implicit;t.xp6(1),t.Oqu(n.created)}}function $(e,o){1&e&&(t.TgZ(0,"th",32),t._uU(1),t.ALo(2,"translate"),t.qZA()),2&e&&(t.xp6(1),t.hij(" ",t.lcZ(2,1,"global_filter.filter_tabs.expires")," "))}function H(e,o){if(1&e&&(t.TgZ(0,"td",35),t._uU(1),t.qZA()),2&e){const n=o.$implicit;t.Q6J("align",n.url_expiration?"left":"center"),t.xp6(1),t.hij(" ",n.url_expiration||"-"," ")}}function B(e,o){1&e&&(t.TgZ(0,"th",36),t._uU(1),t.ALo(2,"translate"),t.qZA()),2&e&&(t.xp6(1),t.hij(" ",t.lcZ(2,1,"global_filter.filter_tabs.download")," "))}function R(e,o){if(1&e&&(t.TgZ(0,"td",37)(1,"mzima-client-button",38),t.ALo(2,"translate"),t._UZ(3,"mat-icon",39),t.qZA()()),2&e){const n=o.$implicit;t.xp6(1),t.Q6J("href",n.url)("iconOnly",!0)("download",t.xi3(2,3,"data_export.job",t.VKq(6,w,n.id)))}}function G(e,o){1&e&&t._UZ(0,"tr",40)}function K(e,o){1&e&&t._UZ(0,"tr",41)}const k=function(){return["name","status","created","expires","download"]};function X(e,o){if(1&e&&(t.TgZ(0,"div",18)(1,"table",19),t.ynx(2,20),t.YNc(3,Y,3,3,"th",21),t.YNc(4,Q,4,6,"td",22),t.BQk(),t.ynx(5,23),t.YNc(6,I,3,3,"th",21),t.YNc(7,P,3,3,"td",22),t.BQk(),t.ynx(8,24),t.YNc(9,F,3,3,"th",21),t.YNc(10,z,2,1,"td",22),t.BQk(),t.ynx(11,25),t.YNc(12,$,3,3,"th",21),t.YNc(13,H,2,2,"td",26),t.BQk(),t.ynx(14,27),t.YNc(15,B,3,3,"th",28),t.YNc(16,R,4,8,"td",29),t.BQk(),t.YNc(17,G,1,0,"tr",30),t.YNc(18,K,1,0,"tr",31),t.qZA()()),2&e){const n=t.oxw(2);t.xp6(1),t.Q6J("dataSource",n.exportJobs),t.xp6(16),t.Q6J("matHeaderRowDef",t.DdM(3,k)),t.xp6(1),t.Q6J("matRowDefColumns",t.DdM(4,k))}}function V(e,o){if(1&e){const n=t.EpF();t.ynx(0),t.TgZ(1,"h1"),t._uU(2),t.ALo(3,"translate"),t.qZA(),t.TgZ(4,"div",4),t.YNc(5,L,2,3,"p",5),t.qZA(),t.TgZ(6,"mat-tab-group",6)(7,"mat-tab",7),t.ALo(8,"translate"),t.YNc(9,q,13,14,"ng-container",8),t.YNc(10,N,1,0,"div",9),t.ALo(11,"async"),t.TgZ(12,"div",10)(13,"mzima-client-button",11),t.NdJ("buttonClick",function(){t.CHM(n);const l=t.oxw();return t.KtG(l.selectFields())}),t._uU(14),t.ALo(15,"translate"),t.qZA(),t.TgZ(16,"mzima-client-button",12),t.NdJ("buttonClick",function(){t.CHM(n);const l=t.oxw();return t.KtG(l.exportAll())}),t._uU(17),t.ALo(18,"translate"),t.qZA()()(),t.TgZ(19,"mat-tab",7),t.ALo(20,"translate"),t.YNc(21,X,19,5,"div",13),t.qZA()(),t.BQk()}if(2&e){const n=t.oxw(),i=t.MAs(4),l=t.MAs(6);t.xp6(2),t.Oqu(t.lcZ(3,17,n.hxlEnabled?"data_export.title_hxl":"data_export.title")),t.xp6(3),t.Q6J("ngIf",n.showProgress)("ngIfElse",i),t.xp6(2),t.Q6J("label",t.lcZ(8,19,"data_export.export"))("data-qa","tab-export"),t.xp6(2),t.Q6J("ngIf",n.hxlEnabled&&!n.hxlApiKey),t.xp6(1),t.Q6J("ngIf",!t.lcZ(11,21,n.isDesktop$)),t.xp6(3),t.Q6J("disabled",n.showProgress)("data-qa","btn-select-fields"),t.xp6(1),t.hij(" ",t.lcZ(15,23,"data_export.select_fields")," "),t.xp6(2),t.Q6J("disabled",n.showProgress)("data-qa","btn-export-all"),t.xp6(1),t.hij(" ",t.lcZ(18,25,"data_export.all")," "),t.xp6(2),t.Q6J("label",t.lcZ(20,27,"data_export.export_history"))("data-qa","tab-export-history"),t.xp6(2),t.Q6J("ngIf",n.exportJobsReady)("ngIfElse",l)}}function W(e,o){if(1&e){const n=t.EpF();t.TgZ(0,"div",50)(1,"mat-checkbox",51),t.NdJ("change",function(){t.CHM(n);const l=t.oxw().$implicit,x=t.oxw(2);return t.KtG(x.selectAll(l))}),t.TgZ(2,"i"),t._uU(3),t.ALo(4,"translate"),t.qZA()()()}if(2&e){const n=t.oxw().$implicit,i=t.oxw(2);t.xp6(1),t.Q6J("checked",i.isAllSelected(n)),t.xp6(2),t.Oqu(t.lcZ(4,2,"category.select_all"))}}function tt(e,o){if(1&e){const n=t.EpF();t.TgZ(0,"div",50)(1,"mat-checkbox",52),t.NdJ("ngModelChange",function(l){const h=t.CHM(n).$implicit,b=t.oxw().$implicit,pt=t.oxw(2);return t.KtG(pt.fieldsMap[b.id][h.key]=l)}),t._uU(2),t.qZA()()}if(2&e){const n=o.$implicit,i=t.oxw().$implicit,l=t.oxw(2);t.xp6(1),t.Q6J("value",n.key)("ngModel",l.fieldsMap[i.id][n.key]),t.xp6(1),t.hij(" ",n.label," ")}}function et(e,o){if(1&e&&(t.TgZ(0,"div",46)(1,"mat-label"),t._uU(2),t.qZA(),t.TgZ(3,"div",47),t.YNc(4,W,5,4,"div",48),t.YNc(5,tt,3,3,"div",49),t.qZA()()),2&e){const n=o.$implicit;t.xp6(2),t.Oqu(n.name),t.xp6(2),t.Q6J("ngIf",n.attributes),t.xp6(1),t.Q6J("ngForOf",n.attributes)}}function nt(e,o){1&e&&t._UZ(0,"div",17)}function ot(e,o){if(1&e){const n=t.EpF();t.TgZ(0,"h1"),t._uU(1),t.ALo(2,"translate"),t.qZA(),t.TgZ(3,"div",4)(4,"p"),t._uU(5),t.ALo(6,"translate"),t.qZA()(),t.YNc(7,et,6,3,"div",42),t.YNc(8,nt,1,0,"div",9),t.ALo(9,"async"),t.TgZ(10,"div",43)(11,"mzima-client-button",44),t.NdJ("buttonClick",function(){t.CHM(n);const l=t.oxw();return t.KtG(l.selectFields())}),t._uU(12),t.ALo(13,"translate"),t.qZA(),t.TgZ(14,"mzima-client-button",45),t.NdJ("buttonClick",function(){t.CHM(n);const l=t.oxw();return t.KtG(l.exportSelected())}),t._uU(15),t.ALo(16,"translate"),t.qZA()()}if(2&e){const n=t.oxw();t.xp6(1),t.Oqu(t.lcZ(2,8,"data_export.select_fields_title")),t.xp6(4),t.Oqu(t.lcZ(6,10,"data_export.select_fields_desc")),t.xp6(2),t.Q6J("ngForOf",n.forms),t.xp6(1),t.Q6J("ngIf",!t.lcZ(9,12,n.isDesktop$)),t.xp6(3),t.Q6J("data-qa","btn-cancel"),t.xp6(1),t.hij(" ",t.lcZ(13,14,"data_export.cancel")," "),t.xp6(2),t.Q6J("data-qa","btn-export-selected"),t.xp6(1),t.hij(" ",t.lcZ(16,16,"data_export.export_selected")," ")}}function at(e,o){1&e&&(t.TgZ(0,"p"),t._uU(1),t.ALo(2,"translate"),t.qZA()),2&e&&(t.xp6(1),t.Oqu(t.lcZ(2,1,"data_export.description")))}function it(e,o){1&e&&(t.TgZ(0,"p"),t._uU(1),t.ALo(2,"translate"),t.TgZ(3,"a",53),t._UZ(4,"mat-icon",54),t._uU(5),t.ALo(6,"translate"),t.qZA(),t._uU(7,", "),t.TgZ(8,"a",55)(9,"strong"),t._UZ(10,"mat-icon",54),t._uU(11),t.ALo(12,"translate"),t.qZA()(),t._uU(13),t.ALo(14,"translate"),t.TgZ(15,"a",56)(16,"strong"),t._UZ(17,"mat-icon",54),t._uU(18),t.ALo(19,"translate"),t.qZA()(),t._uU(20),t.ALo(21,"translate"),t.qZA()),2&e&&(t.xp6(1),t.hij(" ",t.lcZ(2,6,"data_export.description_hxl")," "),t.xp6(4),t.hij(" ",t.lcZ(6,8,"data_export.hxl_tags")," "),t.xp6(6),t.hij(" ",t.lcZ(12,10,"data_export.hxl_attributes")," "),t.xp6(2),t.hij(" ",t.lcZ(14,12,"data_export.and_choose")," "),t.xp6(5),t.hij(" ",t.lcZ(19,14,"data_export.HDX")," "),t.xp6(2),t.hij(" ",t.lcZ(21,16,"data_export.account")," "))}function lt(e,o){if(1&e&&(t.YNc(0,at,3,3,"p",8),t.YNc(1,it,22,18,"p",8)),2&e){const n=t.oxw();t.Q6J("ngIf",!n.hxlEnabled),t.xp6(1),t.Q6J("ngIf",n.hxlEnabled)}}function rt(e,o){1&e&&t._UZ(0,"app-spinner",57)}let f=class Z{formsService;sessionService;usersService;exportJobsService;pollingService;breakpointService;eventBusService;isDesktop$;forms=[];fieldsMap={};exportJobs=[];hxlEnabled=!1;hxlApiKey=!0;showProgress=!1;exportView=!0;exportJobsReady=!1;constructor(o,n,i,l,x,h,b){this.formsService=o,this.sessionService=n,this.usersService=i,this.exportJobsService=l,this.pollingService=x,this.breakpointService=h,this.eventBusService=b,this.isDesktop$=this.breakpointService.isDesktop$.pipe((0,J.t)(this))}ngOnInit(){this.listenEventProcess(),this.formsService.get().subscribe(o=>{this.forms=o.results,this.attachFormAttributes()}),this.initUserSettings(),this.hxlEnabled=!!this.sessionService.getFeatureConfigurations().hxl?.enabled,this.loadExportJobs()}listenEventProcess(){this.eventBusService.on("STOP_EXPORT_POLLING").subscribe({next:o=>this.showProgress=o.process})}initUserSettings(){const o=localStorage.getItem(`${c.X2.o.LOCAL_STORAGE_PREFIX}userId`);o&&this.usersService.getUserSettings(o).subscribe({next:n=>{this.hxlApiKey=n.results?.some(i=>"hdx_api_key"===i.config_key)}})}loadExportJobs(){this.exportJobsReady=!1,this.exportJobsService.get().subscribe({next:o=>{this.exportJobs=o.reverse(),this.exportJobsReady=!0},error:o=>{console.error("Export failed: ",o),this.exportJobsReady=!0}})}exportAll(){this.pollingService.startExport({send_to_hdx:!1,include_hxl:!1,send_to_browser:!0}).subscribe()}selectAll(o){this.isAllSelected(o)?o.attributes?.forEach(n=>{this.fieldsMap[o.id][n.key]=!1}):o.attributes?.forEach(n=>{this.fieldsMap[o.id][n.key]=!0})}isAllSelected(o){return this.getSelectedAttrCount(o.id)===o.attributes?.length}getSelectedAttrCount(o){return Object.values(this.fieldsMap[o]).filter(n=>!!n).length}exportSelected(){this.selectFields();const o=[];Object.keys(this.fieldsMap).forEach(n=>{Object.keys(this.fieldsMap[n]).forEach(i=>{this.fieldsMap[n][i]&&o.push(i)})}),this.pollingService.startExport({fields:o,send_to_hdx:!1,include_hxl:!1,send_to_browser:!0}).subscribe()}selectFields(){this.exportView=!this.exportView}attachFormAttributes(){this.forms.forEach(o=>{this.formsService.getAttributes(o.id.toString()).pipe().subscribe({next:n=>{o.attributes=n,this.fieldsMap[o.id]={}}})})}static \u0275fac=function(n){return new(n||Z)(t.Y36(c.s8),t.Y36(s.mj),t.Y36(c.fz),t.Y36(c.rx),t.Y36(s.xj),t.Y36(s.r),t.Y36(s.Yd))};static \u0275cmp=t.Xpm({type:Z,selectors:[["app-data-export"]],decls:7,vars:2,consts:[[4,"ngIf","ngIfElse"],["fieldSelector",""],["description",""],["showLoader",""],[1,"description"],[3,"innerHTML",4,"ngIf","ngIfElse"],["dynamicHeight","","disableRipple","","disablePagination","","animationDuration","0ms"],[3,"label","data-qa"],[4,"ngIf"],["class","form-controls-spacer",4,"ngIf"],[1,"form-controls-panel"],["fill","outline","color","secondary",3,"disabled","data-qa","buttonClick"],[3,"disabled","data-qa","buttonClick"],["class","history-table",4,"ngIf","ngIfElse"],[3,"innerHTML"],[1,"alert"],[1,"link-blue",3,"routerLink"],[1,"form-controls-spacer"],[1,"history-table"],["mat-table","",3,"dataSource"],["matColumnDef","name"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","status"],["matColumnDef","created"],["matColumnDef","expires"],["mat-cell","",3,"align",4,"matCellDef"],["matColumnDef","download"],["mat-header-cell","","align","center",4,"matHeaderCellDef"],["mat-cell","","align","center",4,"matCellDef"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["mat-header-cell",""],["mat-cell",""],[1,"title"],["mat-cell","",3,"align"],["mat-header-cell","","align","center"],["mat-cell","","align","center"],["fill","clear","color","secondary",1,"download-btn",3,"href","iconOnly","download"],["icon","","svgIcon","download"],["mat-header-row",""],["mat-row",""],["class","form-row",4,"ngFor","ngForOf"],[1,"form-controls-panel","form-controls-panel--sticky"],["fill","outline","color","secondary",3,"data-qa","buttonClick"],[3,"data-qa","buttonClick"],[1,"form-row"],[1,"checkbox-group"],["class","checkbox",4,"ngIf"],["class","checkbox",4,"ngFor","ngForOf"],[1,"checkbox"],[3,"checked","change"],[3,"value","ngModel","ngModelChange"],["href","https://hxlstandard.org/standard/1-1final/tagging/","target","_blank",1,"link-blue"],["svgIcon","external-link"],["href","https://hxlstandard.org/standard/1-1final/dictionary/","target","_blank",1,"link-blue"],["href","https://data.humdata.org/","target","_blank",1,"link-blue"],[1,"spinner"]],template:function(n,i){if(1&n&&(t.YNc(0,V,22,29,"ng-container",0),t.YNc(1,ot,17,18,"ng-template",null,1,t.W1O),t.YNc(3,lt,2,2,"ng-template",null,2,t.W1O),t.YNc(5,rt,1,0,"ng-template",null,3,t.W1O)),2&n){const l=t.MAs(2);t.Q6J("ngIf",i.exportView)("ngIfElse",l)}},dependencies:[p.sg,p.O5,u.yS,g.SP,g.uX,S.xG,r.BZ,r.fO,r.as,r.w1,r.Dz,r.nj,r.ge,r.ev,r.XQ,r.Gk,C.oG,m.JJ,m.On,T.Hw,U.O,A.hX,M.r,p.Ov,p.rS,E.X$],styles:[".description[_ngcontent-%COMP%]{max-width:654px;margin-bottom:32px}.description[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]{width:1em;height:1em;line-height:1;margin:-3px 0;font-size:24px;vertical-align:top}.mat-column-download[_ngcontent-%COMP%]{text-align:center}.download-btn[_ngcontent-%COMP%]{padding:0;width:32px;height:32px;min-width:0;display:flex;margin:0 auto;line-height:32px;border-radius:50%;align-items:center;flex-direction:column;justify-content:center}.download-btn[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]{font-size:24px}.spinner[_ngcontent-%COMP%]{display:block;margin:150px 0}@media only screen and (max-width: 768px){.history-table[_ngcontent-%COMP%]{overflow-x:auto;overflow-y:hidden;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}.history-table[_ngcontent-%COMP%]   .mat-table[_ngcontent-%COMP%]{min-width:680px}}"]})};f=(0,y.gn)([(0,J.c)(),(0,y.w6)("design:paramtypes",[c.s8,s.mj,c.fz,c.rx,s.xj,s.r,s.Yd])],f);const st=[{path:"",component:f}];class _{static \u0275fac=function(n){return new(n||_)};static \u0275mod=t.oAB({type:_});static \u0275inj=t.cJS({imports:[u.Bz.forChild(st),u.Bz]})}var ct=a(17733);class d{static \u0275fac=function(n){return new(n||d)};static \u0275mod=t.oAB({type:d});static \u0275inj=t.cJS({imports:[p.ez,_,E.aw,g.Nh,D.Z6,O.ot,r.p0,C.p9,m.u5,T.Ps,D.Fm,A.lN,ct.e]})}}}]);
//# sourceMappingURL=122.96d4c355253b8037.js.map