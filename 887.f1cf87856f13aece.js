"use strict";(self.webpackChunkweb_mzima_client=self.webpackChunkweb_mzima_client||[]).push([[887],{71887:(N,z,i)=>{i.r(z),i.d(z,{MapModule:()=>M});var w=i(52954),Y=i(95432),S=i(69420),E=i(37661),J=i(63953),L=i(95236),Z=i(81547),I=i(89857),d=i(40930),k=i(4540),t=i(39609),P=i(10909),C=i(20117),f=i(78275),D=(i(59905),i(21491)),j=i(75471),G=i(36368),c=i(49119),h=i(59132);function H(m,s){if(1&m&&t._UZ(0,"mat-progress-bar",3),2&m){const e=t.oxw();t.Q6J("value",e.progress)}}function $(m,s){if(1&m){const e=t.EpF();t.TgZ(0,"div",4),t.NdJ("leafletMapReady",function(l){t.CHM(e);const r=t.oxw();return t.KtG(r.onMapReady(l))}),t.qZA()}if(2&m){const e=t.oxw();t.Q6J("leafletOptions",e.leafletOptions)("leafletLayers",e.mapLayers)("leafletFitBounds",e.mapFitToBounds)("leafletFitBoundsOptions",e.fitBoundsOptions)}}const W=function(m,s){return{"map-holder--filters-visible":m,"map-holder--no-offset":s}};let g=class T extends I.z9{router;route;postsService;savedSearchesService;eventBusService;sessionService;breakpointService;view;dialog;zone;mediaService;map;postsCollection;mapLayers=[];mapReady=!1;mapConfig;markerClusterData=new f.MarkerClusterGroup;markerClusterOptions={animate:!0,maxClusterRadius:50};mapFitToBounds;fitBoundsOptions={animate:!0};cachedFilter;filtersSubscription$;leafletOptions;progress=0;isFiltersVisible;isMainFiltersOpen;constructor(s,e,a,l,r,v,x,y,o,n,p){super(s,e,a,l,r,v,x),this.router=s,this.route=e,this.postsService=a,this.savedSearchesService=l,this.eventBusService=r,this.sessionService=v,this.breakpointService=x,this.view=y,this.dialog=o,this.zone=n,this.mediaService=p,this.filtersSubscription$=this.postsService.postsFilters$.pipe((0,P.oJ)())}ngOnInit(){this.reInitParams(),this.route.params.subscribe(()=>{this.initCollection()}),this.initFilterListener(),this.mapConfig=this.sessionService.getMapConfigurations();const s=P.Lz.getMapLayers().baselayers[this.mapConfig.default_view.baselayer];this.leafletOptions={minZoom:1,maxZoom:22,scrollWheelZoom:!0,zoomControl:!1,layers:[(0,f.tileLayer)(s.url,s.layerOptions)],center:[this.mapConfig.default_view.lat,this.mapConfig.default_view.lon],zoom:this.mapConfig.default_view.zoom},this.markerClusterOptions.maxClusterRadius=this.mapConfig.cluster_radius,this.mapReady=!0,this.eventBusService.on("SEARCH_OPTION_SELECTED").subscribe({next:e=>{this.map.setZoom(12),this.map.panTo({lat:e.lat,lng:e.lon})}}),this.sessionService.isFiltersVisible$.pipe((0,C.t)(this)).subscribe({next:e=>{setTimeout(()=>{this.isFiltersVisible=e},1)}}),this.sessionService.isMainFiltersHidden$.pipe((0,C.t)(this)).subscribe({next:e=>{setTimeout(()=>{this.isMainFiltersOpen=!e},1)}}),this.initCollectionRemoveListener(),this.getUserData()}loadData(){this.getPostsGeoJson()}initFilterListener(){this.filtersSubscription$.pipe((0,D.b)(1e3)).subscribe({next:s=>{"search"===this.route.snapshot.data.view&&!this.searchId||"collection"===this.route.snapshot.data.view&&!this.collectionId||this.getPostsGeoJson(1,s)}})}reInitParams(){this.params.page=1,this.params.limit=500,this.params.currentView="map",this.resetMapLayers(),this.mapLayers=[]}resetMapLayers(){this.mapLayers.map(s=>{this.map.removeLayer(s),this.markerClusterData.removeLayer(s)})}onMapReady(s){this.map=s;const e=localStorage.getItem("bounds");if(null===e)this.map.setZoom(this.leafletOptions.zoom??this.leafletOptions.minZoom??1);else{const{fit:a,zoom:l,center:r}=JSON.parse(e);this.map.setMaxBounds(a),this.map.setView([r.lat,r.lng],l,{animate:!1})}f.control.zoom({position:"bottomleft"}).addTo(s)}getPostsGeoJson(s=1,e){this.postsService.getGeojson({...this.params,page:s}).pipe((0,C.t)(this)).subscribe({next:a=>{const l=a.results.map(o=>({type:o.geojson?.type,features:o.geojson?.features.map(n=>(n.properties={data_source_message_id:o.data_source_message_id,description:o.description,id:o.id,"marker-color":o["marker-color"],source:o.source,title:o.title},n))??[]})),r=(0,f.geoJSON)(l,{pointToLayer:P.Lz.pointToLayer,onEachFeature:(o,n)=>{n.on("mouseout",()=>{n.unbindPopup()}),n.on("click",()=>{this.zone.run(()=>{if(n instanceof f.FeatureGroup&&(n=n.getLayers()[0]),n.getPopup())n.openPopup();else{const p=this.view.createComponent(j.X);this.postsService.getById(o.properties.id).subscribe({next:b=>{p.setInput("post",b),p.setInput("user",this.user),this.postsService.getById(o.properties.id).subscribe({next:O=>{p.instance.details$.subscribe({next:()=>{this.showPostDetailsModal(O,b.color,b.data_source_message_id)}}),p.instance.edit.subscribe({next:()=>{this.showPostDetailsModal(O,b.color,b.data_source_message_id,!0)}}),p.instance.deleted$.subscribe({next:()=>{p.destroy(),this.map.closePopup(),this.mapLayers.forEach(u=>{u.eachLayer(R=>{R.feature.properties.id===O.id&&u.removeLayer(R)})}),this.loadData(),this.eventBusService.next({type:"REFRESH_SURVEYS_COUNTERS",payload:!0})}});const B=O.post_content?.[0].fields.find(u=>"media"===u.type);B&&B.value?.value&&this.mediaService.getById(B.value.value).subscribe({next:u=>{p.setInput("media",u.result)}}),n.bindPopup(p.location.nativeElement,{maxWidth:360,minWidth:360,maxHeight:window.innerHeight-176,closeButton:!1,className:"pl-popup"}),n.openPopup()}})}})}})})}}),v=0===this.mapLayers.length,x=s>1&&a.meta.total!==this.mapLayers[0].getLayers().length;let y=!1;if(void 0!==e){const o=JSON.stringify(e);this.cachedFilter&&o!==this.cachedFilter&&(y=!0),this.cachedFilter=o}else y=void 0===this.cachedFilter;if(v||y||x)if(!v&&!x&&this.resetMapLayers(),this.mapConfig.clustering?(this.markerClusterData.addLayer(r),this.mapLayers.push(this.markerClusterData)):this.mapLayers.push(r),this.params.limit&&s&&a.meta.total>this.params.limit*s)this.progress=this.params.limit*s/a.count*100,s++,this.params.page=s,this.getPostsGeoJson(s,e);else if(this.progress=100,a.results.length){this.mapFitToBounds=r.getBounds();const o={fit:this.mapFitToBounds,zoom:this.map.getBoundsZoom(this.mapFitToBounds),center:this.map.getCenter()};localStorage.setItem("bounds",JSON.stringify(o))}},error:a=>{a.message.match(/Http failure response for/)&&setTimeout(()=>this.getPostsGeoJson(),5e3)}})}showPostDetailsModal(s,e,a,l){this.dialog.open(G.w,{width:"100%",maxWidth:576,data:{post:s,color:e,twitterId:a,editable:l},height:"auto",maxHeight:"90vh",panelClass:["modal","post-modal"]})}static \u0275fac=function(e){return new(e||T)(t.Y36(d.F0),t.Y36(d.gz),t.Y36(c.PJ),t.Y36(c.lF),t.Y36(h.Yd),t.Y36(h.mj),t.Y36(h.r),t.Y36(t.s_b),t.Y36(S.uw),t.Y36(t.R0b),t.Y36(c.yJ))};static \u0275cmp=t.Xpm({type:T,selectors:[["app-map"]],features:[t.qOj],decls:3,vars:6,consts:[[1,"map-holder",3,"ngClass"],["class","progress-bar","mode","determinate",3,"value",4,"ngIf"],["class","map","leaflet","",3,"leafletOptions","leafletLayers","leafletFitBounds","leafletFitBoundsOptions","leafletMapReady",4,"ngIf"],["mode","determinate",1,"progress-bar",3,"value"],["leaflet","",1,"map",3,"leafletOptions","leafletLayers","leafletFitBounds","leafletFitBoundsOptions","leafletMapReady"]],template:function(e,a){1&e&&(t.TgZ(0,"div",0),t.YNc(1,H,1,1,"mat-progress-bar",1),t.YNc(2,$,1,4,"div",2),t.qZA()),2&e&&(t.Q6J("ngClass",t.WLB(3,W,a.isFiltersVisible,!a.isMainFiltersOpen)),t.xp6(1),t.Q6J("ngIf",a.progress<100),t.xp6(1),t.Q6J("ngIf",a.mapReady))},dependencies:[w.mk,w.O5,J.pW,L.je,L.x],styles:[".map-holder[_ngcontent-%COMP%]{height:100%;position:relative;transition:transform .35s ease}@media only screen and (max-width: 1024px){.map-holder[_ngcontent-%COMP%]{inset:80px 0;height:auto;position:fixed}}@media only screen and (min-width: 1025px){.map-holder[_ngcontent-%COMP%]:not(.map-holder--no-offset){transform:translate(110px)}}@media only screen and (min-width: 1025px) and (max-width: 1366px){.map-holder[_ngcontent-%COMP%]:not(.map-holder--no-offset){transform:translate(100px)}}.progress-bar[_ngcontent-%COMP%]{top:0;left:0;right:0;z-index:50;position:absolute}.map[_ngcontent-%COMP%]{z-index:15;height:100%;position:relative}@media only screen and (min-width: 1025px){.map[_ngcontent-%COMP%]{min-height:400px}}  .pl-popup .leaflet-popup-content-wrapper{padding:0;box-shadow:none;text-align:start;border-radius:8px}  .pl-popup .leaflet-popup-content{margin:0;border:none;overflow-y:auto;min-width:464px;overflow-x:hidden;border-radius:8px;scroll-behavior:smooth;padding:20px 24px 16px 34px;max-height:calc(100vh - 176px);-webkit-overflow-scrolling:touch}@media only screen and (max-width: 768px){  .pl-popup .leaflet-popup-content{width:464px;min-width:0;padding:16px 16px 12px 26px;max-width:calc(100vw - 32px)}}  .pl-popup .leaflet-popup-tip{padding:0;width:16px;height:16px;box-shadow:none;margin-top:-8px}  .marker-cluster-small,   .marker-cluster-medium,   .marker-cluster-large{display:flex;align-items:center;flex-direction:column;justify-content:center}  .marker-cluster-small div,   .marker-cluster-medium div,   .marker-cluster-large div{margin:0;font-size:12px;font-family:inherit}  .marker-cluster-small,   .marker-cluster-medium{border-radius:50%;width:45px!important;height:45px!important;margin-top:-22px!important;margin-inline-start:-22px!important}  .marker-cluster-small div,   .marker-cluster-medium div{width:27px;height:27px;line-height:27px;border-radius:50%}  .marker-cluster-small{background:rgba(255,195,52,.23)}  .marker-cluster-small div{background:var(--color-primary-60)}  .marker-cluster-medium{background:rgba(255,174,52,.23)}  .marker-cluster-medium div{background:#ffae34}  .marker-cluster-large{width:56px!important;height:56px!important;margin-top:-28px!important;margin-left:-28px!important;background:rgba(255,137,52,.23)}  .marker-cluster-large div{width:34px;height:34px;line-height:34px;background:#ff8934}  .marker-cluster span{line-height:inherit}"]})};g=(0,k.gn)([(0,C.c)(),(0,k.w6)("design:paramtypes",[d.F0,d.gz,c.PJ,c.lF,h.Yd,h.mj,h.r,t.s_b,S.uw,t.R0b,c.yJ])],g);const A=[{path:"",component:g},{path:"collection",redirectTo:"",children:[{path:":id",component:g,data:{view:"collection"}}]},{path:"search",redirectTo:"",children:[{path:":id",component:g,data:{view:"search"}}]}];class F{static \u0275fac=function(e){return new(e||F)};static \u0275mod=t.oAB({type:F});static \u0275inj=t.cJS({imports:[d.Bz.forChild(A),d.Bz]})}var Q=i(45948),U=i(17733);class M{static \u0275fac=function(e){return new(e||M)};static \u0275mod=t.oAB({type:M});static \u0275inj=t.cJS({imports:[w.ez,F,Q.PostModule,J.Cv,Y.ot,E.Ps,S.Is,L.UO,Z.aw,I.Z6,U.e]})}}}]);
//# sourceMappingURL=887.f1cf87856f13aece.js.map